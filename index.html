<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gmail Style Supabase Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      margin: 0;
    }
    #auth, #chat-app {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #auth form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-width: 300px;
      background: #f9f9f9;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px #0001;
    }
    #auth input {
      padding: 0.5rem;
      font-size: 1rem;
    }
    #auth button {
      padding: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
    }
    #auth .switch {
      background: none;
      border: none;
      color: #007bff;
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.9rem;
      margin-top: -0.5rem;
    }
    #messages {
      width: 70%;
      border-right: 1px solid #ccc;
      padding: 1rem;
      overflow-y: auto;
    }
    #composer {
      width: 30%;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: #f9f9f9;
    }
    textarea {
      resize: none;
      width: 100%;
      height: 150px;
    }
    .message {
      margin-bottom: 1rem;
      padding: 0.5rem;
      background: #e9ecef;
      border-radius: 5px;
    }
    #logout-btn {
      position: absolute;
      top: 10px;
      right: 20px;
      padding: 0.5rem 1rem;
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="auth">
    <form id="login-form">
      <h2 id="form-title">Connexion</h2>
      <input type="text" id="pseudo" placeholder="Pseudo" required />
      <input type="password" id="mdp" placeholder="Mot de passe" required />
      <button type="submit" id="submit-btn">Se connecter</button>
      <button type="button" class="switch" id="switch-auth">Cr√©er un compte</button>
      <div id="auth-error" style="color:red"></div>
    </form>
  </div>

  <div id="chat-app" style="display:none; width:100vw; height:100vh;">
    <button id="logout-btn">D√©connexion</button>
    <div id="messages">
      <h2>üì® Messages</h2>
      <div id="message-list"></div>
    </div>
    <div id="composer">
      <h2>‚úâÔ∏è √âcrire un message</h2>
      <select id="destinataire-select">
        <option value="">Choisir un destinataire</option>
      </select>
      <textarea id="message-input" placeholder="Tape ton message ici..."></textarea>
      <button id="send-btn">Envoyer</button>
    </div>
  </div>

  <script type="module">
// Connexion √† Supabase
import { createClient } from 'https://esm.sh/@supabase/supabase-js'

const SUPABASE_URL = 'https://txwcdojzbvkqskseufoe.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4d2Nkb2p6YnZrcXNrc2V1Zm9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxMzYyODIsImV4cCI6MjA2NzcxMjI4Mn0.daiRfXm_6d8R_i9-tDMIMLS9YGtmvZ6yacQpQ94CLAU'
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// Elements
const authDiv = document.getElementById('auth')
const chatDiv = document.getElementById('chat-app')
const loginForm = document.getElementById('login-form')
const pseudoInput = document.getElementById('pseudo')
const mdpInput = document.getElementById('mdp')
const submitBtn = document.getElementById('submit-btn')
const switchAuthBtn = document.getElementById('switch-auth')
const formTitle = document.getElementById('form-title')
const authError = document.getElementById('auth-error')
const logoutBtn = document.getElementById('logout-btn')

// Chat elements
const messageList = document.getElementById('message-list')
const messageInput = document.getElementById('message-input')
const sendBtn = document.getElementById('send-btn')
const destinataireSelect = document.getElementById('destinataire-select')

// Auth mode
let isLogin = true
let currentUser = null

switchAuthBtn.addEventListener('click', () => {
  isLogin = !isLogin
  formTitle.textContent = isLogin ? 'Connexion' : 'Cr√©er un compte'
  submitBtn.textContent = isLogin ? 'Se connecter' : 'Cr√©er un compte'
  switchAuthBtn.textContent = isLogin ? 'Cr√©er un compte' : 'D√©j√† inscrit ? Se connecter'
  authError.textContent = ''
})

loginForm.addEventListener('submit', async (e) => {
  e.preventDefault()
  authError.textContent = ''
  const pseudo = pseudoInput.value.trim()
  const mdp = mdpInput.value.trim()
  if (!pseudo || !mdp) return

  if (isLogin) {
    // Connexion
    const { data, error } = await supabase
      .from('users')
      .select('*')
      .eq('pseudo', pseudo)
      .eq('mdp', mdp)
      .single()
    if (error || !data) {
      authError.textContent = "Pseudo ou mot de passe incorrect"
    } else {
      currentUser = data
      showChat()
    }
  } else {
    // Inscription
    // V√©rifie si le pseudo existe d√©j√†
    const { data: exists } = await supabase
      .from('users')
      .select('id')
      .eq('pseudo', pseudo)
      .single()
    if (exists) {
      authError.textContent = "Ce pseudo existe d√©j√†"
      return
    }
    // Cr√©e le compte
    const { error } = await supabase
      .from('users')
      .insert([{ pseudo, mdp }])
    if (error) {
      authError.textContent = "Erreur lors de la cr√©ation du compte"
    } else {
      authError.textContent = "Compte cr√©√© ! Connectez-vous."
      isLogin = true
      formTitle.textContent = 'Connexion'
      submitBtn.textContent = 'Se connecter'
      switchAuthBtn.textContent = 'Cr√©er un compte'
    }
  }
})

function showChat() {
  authDiv.style.display = 'none'
  chatDiv.style.display = 'flex'
  messageList.innerHTML = ''
  messageInput.value = ''
  loadUsers()
  loadMessages()
  subscribeToMessages()
}

// Charger la liste des utilisateurs pour le menu d√©roulant
async function loadUsers() {
  const { data, error } = await supabase
    .from('users')
    .select('pseudo')
  if (!error && data) {
    destinataireSelect.innerHTML = '<option value="">Choisir un destinataire</option>'
    data
      .filter(u => u.pseudo !== currentUser.pseudo)
      .forEach(u => {
        const opt = document.createElement('option')
        opt.value = u.pseudo
        opt.textContent = u.pseudo
        destinataireSelect.appendChild(opt)
      })
  }
}

// Afficher les messages o√π je suis destinataire ou exp√©diteur
async function loadMessages() {
  if (!currentUser) return
  const { data, error } = await supabase
    .from('messages')
    .select('*')
    .or(`expediteur.eq.${currentUser.pseudo},destinataire.eq.${currentUser.pseudo}`)
    .order('id', { ascending: true })

  if (!error && data) {
    messageList.innerHTML = ''
    data.forEach(addMessage)
  }
}

function addMessage(msg) {
  let exp = msg.expediteur === currentUser.pseudo ? "Vous" : msg.expediteur
  let dest = msg.destinataire === currentUser.pseudo ? "Vous" : msg.destinataire
  const div = document.createElement('div')
  div.className = 'message'
  div.textContent = `[${exp} ‚Üí ${dest}] ${msg.message}`
  messageList.appendChild(div)
  messageList.scrollTop = messageList.scrollHeight
}

// Envoyer un message
sendBtn.addEventListener('click', async () => {
  const content = messageInput.value.trim()
  const destinataire = destinataireSelect.value
  if (content === '' || !currentUser || !destinataire) return

  const expediteur = currentUser.pseudo

  const { error } = await supabase
    .from('messages')
    .insert([{ message: content, expediteur, destinataire }])

  if (error) {
    alert('Erreur lors de l‚Äôenvoi.')
    console.error(error)
  } else {
    messageInput.value = ''
  }
})

// √âcouter les nouveaux messages en temps r√©el
let channel
function subscribeToMessages() {
  if (channel) channel.unsubscribe()
  channel = supabase
    .channel('realtime-messages')
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'messages',
      },
      (payload) => {
        const msg = payload.new
        if (
          msg.expediteur === currentUser.pseudo ||
          msg.destinataire === currentUser.pseudo
        ) {
          addMessage(msg)
        }
      }
    )
    .subscribe()
}

logoutBtn.addEventListener('click', async () => {
  authDiv.style.display = 'flex'
  chatDiv.style.display = 'none'
  currentUser = null
  messageList.innerHTML = ''
  messageInput.value = ''
  if (channel) {
    channel.unsubscribe()
    channel = null
  }
})

  </script>
</body>
</html>
